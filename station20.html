<!-- OEBC OSCE Station 20 – Pterygium Counselling (Interactive, with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 20</h2>

  <p style="margin-top: 0; color: #555;">Module 3 &ndash; Anterior Segment &amp; Adnexa &bull; Pterygium (Interactive)</p>

  <!-- Step 1: Read -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

    <p><strong>Exam Context:</strong> On the real OEBC OSCE, you would have about 8 minutes at this station to communicate clearly with the patient.</p>

    <p><strong>Scenario:</strong>
      <br>A 42-year-old outdoor construction worker presents for a routine eye exam. He reports a <em>&ldquo;yellow growth on the white of my eye&rdquo;</em> that has been slowly getting bigger over the last few years and sometimes feels gritty or irritated, especially in wind and sun. Vision is currently 20/20 OU with mild refractive error.
      <br>
      <br>Slit lamp findings:</p>

    <ul style="margin-top: 0;">
      <li>Nasal, triangular fibrovascular growth extending 2.0 mm onto the cornea OD</li>
      <li>Mild conjunctival injection adjacent to the lesion</li>
      <li>No corneal ulceration or dellen; tear film slightly reduced</li>
      <li>OS with small pinguecula, no corneal encroachment</li>
    </ul>

    <p><strong>Your task:</strong> You have finished your examination and confirmed the diagnosis of a pterygium OD. Explain the diagnosis and management plan to the patient in clear, patient-friendly language. Make sure your explanation includes:</p>

    <ul>
      <li>What the condition is and how it relates to UV / environmental exposure</li>
      <li>How it may affect the eye and vision now and in the future (including possible progression)</li>
      <li>Non-surgical management (lubrication, UV protection, modifiable risk factors)</li>
      <li>When surgical removal would be recommended and possible recurrence risk</li>
      <li>Follow-up / monitoring plan</li>
    </ul>
  </div>

  <!-- Step 2: Respond -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

    <p>Type what you would say directly to the patient as if you were in the exam room:</p>
    <textarea id="s20-response" rows="8" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:8px;">
      <button type="button"
        onclick="document.getElementById('s20-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS20AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3 + 4: Key Points & Rubric (Hidden by Default) -->
  <div id="s20-key" style="display: none;">
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

      <ul>
        <li><strong>Diagnosis:</strong> Clearly name the condition as a pterygium and describe it as a benign growth of tissue on the white of the eye that can grow onto the cornea.</li>
        <li><strong>Etiology / Risk Factors:</strong> Explain that it is strongly associated with long-term UV exposure, wind, dust, and dry environments (common in outdoor work).</li>
        <li><strong>Current Impact:</strong> Reassure that vision is currently normal but acknowledge symptoms: irritation, foreign body sensation, cosmetic concern.</li>
        <li><strong>Potential Progression:</strong> Explain that it may grow further onto the cornea, induce astigmatism, or eventually affect vision if it encroaches toward the visual axis.</li>
        <li><strong>Non-Surgical Management:</strong>
          <ul>
            <li>Lubricating drops for irritation</li>
            <li>UV-protective eyewear (wrap-around sunglasses), wide-brim hat</li>
            <li>Avoidance/reduction of environmental irritants where possible</li>
          </ul>
        </li>
        <li><strong>Indications for Surgery:</strong>Discuss that surgery is considered if:
          <ul>
            <li>It threatens or reduces vision (approaching the visual axis or causing significant astigmatism)</li>
            <li>There is frequent inflammation or discomfort not controlled with drops</li>
            <li>There is significant cosmetic concern for the patient</li>
          </ul>
        </li>
        <li><strong>Recurrence &amp; Prognosis:</strong> Mention that even after removal, pterygia can recur, especially without UV protection, but modern techniques help reduce this risk.</li>
        <li><strong>Follow-Up Plan:</strong> Provide a clear monitoring recommendation (e.g., yearly or sooner if symptoms worsen or growth is noticed).</li>
        <li><strong>Communication Style:</strong> Use clear, non-alarming language, invite questions, and check understanding.</li>
      </ul>
    </div>

    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

      <p>Score yourself from 0&ndash;2 in each area (0 = not addressed, 1 = partial, 2 = fully). Total possible = 10 points.</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Named pterygium and clearly described what it is.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation &amp; Etiology</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Linked the condition to UV / environmental exposure and explained why it occurs.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Discussed lubrication, UV protection, and lifestyle modification clearly.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Surgery, Prognosis &amp; Follow-Up</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Outlined when surgery is indicated, recurrence risk, and a monitoring plan.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Tone was empathetic, organized, and understandable for a layperson.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">If you consistently meet all domains across many stations, you are practicing at a communication level similar to what OEBC expects on anterior segment interactive stations.</p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback -->
  <div id="s20-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s20-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      “The growth you’ve noticed on the white part of your right eye is called a <strong>pterygium</strong>.
      It’s a benign, non-cancerous piece of tissue that starts on the conjunctiva and slowly grows onto the
      clear front window of the eye, the cornea. It’s very common in people who work outdoors, like you, because
      it’s strongly linked to <strong>sun/UV exposure, wind, and dust</strong> over many years.<br><br>

      Right now, your vision is still 20/20, which is great. The main issues are irritation, that gritty feeling,
      and the cosmetic appearance. We’ll start with <strong>non-surgical treatments</strong>: lubricating drops to
      keep it comfortable and protecting your eyes from UV and wind with good wrap-around sunglasses and, when
      possible, a brimmed hat. Those steps can help slow progression and keep symptoms under control.<br><br>

      We keep an eye on pterygia because they <strong>can grow</strong>. If it starts to approach the central
      part of your vision or cause significant astigmatism, or if it stays inflamed despite drops, then we talk
      about surgery to remove it. Even with surgery, there is some chance it can come back, especially if UV
      exposure continues, but modern techniques and good protection afterward help lower that risk.<br><br>

      For now, I’d like to see you <strong>about once a year</strong>, or sooner if you notice it growing quickly
      or symptoms worsening. At each visit we’ll re-check its size, your vision, and your comfort. Does this help
      explain what’s going on and why we’re focusing so much on sun and wind protection?”
    </div>
  </div>
</div>

<script>
  async function getS20AiFeedback() {
    const textArea     = document.getElementById("s20-response");
    const feedbackBox  = document.getElementById("s20-ai-box");
    const feedbackText = document.getElementById("s20-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 20,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c";
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
