<!-- OEBC OSCE Station 2 – Interactive Myopia Progression Counseling (with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE – Station 2</h2>
  <p style="margin-top: 0; color: #555;">Module 1 – Refractive • Myopia (Interactive – Counseling &amp; Management)</p>

  <!-- Step 1: Read -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">
    <h3 style="margin-top: 0;">Step 1 – Read the Station</h3>

    <p><strong>Instructions:</strong> Read the scenario carefully. On the real OEBC OSCE, you would have 8 minutes to complete this station.</p>

    <p><strong>Scenario:</strong></p>

    <p>A 12-year-old patient presents with their parent. The child reports increasing difficulty seeing the board at school and squinting at the TV. Previous spectacle prescription from one year ago was:</p>

    <ul>
      <li>OD: &minus;1.50 DS</li>
      <li>OS: &minus;1.50 DS</li>
    </ul>

    <p>Today’s refraction is:</p>

    <ul>
      <li>OD: &minus;2.50 DS (20/20)</li>
      <li>OS: &minus;2.75 DS (20/20)</li>
    </ul>

    <p>Ocular health is normal. Axial length measurements (if available in your clinic) show a mild increase in both eyes over the past year.</p>

    <p><strong>Your task:</strong> Speak to the parent and child together. Explain:</p>
    <ul>
      <li>What myopia is and why the prescription has changed.</li>
      <li>What “myopia progression” means and why it matters long-term.</li>
      <li>Reasonable management options (e.g., updated glasses, contact lens options, myopia control strategies where appropriate).</li>
      <li>Daily-living advice (near work, outdoor time, posture / working distance).</li>
      <li>Recommended follow-up interval and what to monitor over time.</li>
    </ul>
    <p>Use clear, reassuring, age-appropriate language.</p>
  </div>

  <!-- Step 2: Respond -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">
    <h3 style="margin-top: 0;">Step 2 – Speak (Type) Your Response</h3>

    <p>Type what you would say to the child and parent:</p>
    <textarea id="s2-response" rows="8" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px;">
      <button type="button"
        onclick="document.getElementById('s2-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS2AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3 + 4: Key Points & Rubric (Hidden by Default) -->
  <div id="s2-key" style="display: none;">
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">
      <h3 style="margin-top: 0;">Key Communication Points (What OEBC-style Stations Expect)</h3>
      <ul>
        <li><strong>Diagnosis:</strong> Clearly state that the child has myopia and that it has increased since last year.</li>
        <li><strong>Basic Explanation:</strong> Explain that light focuses in front of the retina without glasses, causing distance blur.</li>
        <li><strong>Progression Concept:</strong> Describe “myopia progression” in simple terms and why keeping it from increasing too quickly can be important (e.g., higher myopia → higher risk of retinal problems, etc.).</li>
        <li><strong>Management Options:</strong> Mention an updated spectacle prescription and, where appropriate in your scope/region, options such as:
          <ul>
            <li>Myopia-control spectacle lenses or contact lenses</li>
            <li>Low-dose atropine (if applicable within local practice norms and discussed appropriately)</li>
          </ul>
        </li>
        <li><strong>Behavioural Advice:</strong> Include at least one or two specific lifestyle recommendations (e.g., more outdoor time, regular breaks from near work, appropriate working distance).</li>
        <li><strong>Follow-Up:</strong> Recommend a reasonable follow-up interval (e.g., 6–12 months, or sooner if rapid change) and what you will monitor (prescription, axial length if available, ocular health).</li>
        <li><strong>Tone &amp; Clarity:</strong> Use age-appropriate, non-blaming language; reassure while still emphasizing the importance of monitoring.</li>
      </ul>
    </div>

    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">
      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>
      <p>Score each area 0–2 (0 = not addressed, 1 = partially, 2 = clearly and completely addressed).</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Stated that the child has myopia and that the prescription has increased since last visit.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained in simple terms how the eye focuses light and why distance vision is blurry without correction.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Progression &amp; Risk</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Addressed what myopia progression means and why monitoring / limiting progression matters.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management Plan</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Offered specific management strategies (updated Rx, possible myopia-control options) and involved parent/child in decision-making.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Lifestyle &amp; Follow-Up</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Included at least one concrete behavioural recommendation and a clear follow-up interval.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Organized, empathetic, and age-appropriate; checked for understanding or invited questions.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top:0.75rem; color:#555; font-style:italic;">
        If you are consistently scoring 1–2 in all domains across stations, you are practicing at a level similar to OEBC interactive stations.
      </p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback (box is present but empty until button is clicked) -->
  <div id="s2-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s2-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      “Thanks for coming in today. Your child is nearsighted, which means their eyes focus light
      in front of the retina without glasses, so things far away look blurry. Since last year, their
      prescription has increased from about &minus;1.50 in each eye to around &minus;2.50 and &minus;2.75.
      That tells us the myopia is progressing, which is common at this age but something we want to
      monitor closely because higher levels of myopia can be associated with a slightly higher risk of
      retinal problems later in life.<br><br>

      Today we’ll update the glasses so they can see clearly at school and for activities. We can also
      talk about options designed to help slow down myopia progression, such as special spectacle lenses
      or contact lenses made for myopia control, and in some cases low-dose atropine eye drops, depending
      on what you’re comfortable with and what is appropriate for your child.<br><br>

      Day to day, it helps to take regular breaks from close work like reading or screens and to spend more
      time outdoors—those habits may support healthier eye growth. I recommend we recheck vision and the
      prescription in about 6–12 months, or sooner if you notice they’re squinting again or struggling to see
      the board. Do you have any questions or concerns about these options so far?”
    </div>
  </div>
</div>

<script>
  async function getS2AiFeedback() {
    const textArea    = document.getElementById("s2-response");
    const feedbackBox = document.getElementById("s2-ai-box");
    const feedbackText = document.getElementById("s2-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 2,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data = await res.json();
      const rubric = data.rubric || {};

      // Safely read scores
      const diagnosisScore      = rubric.diagnosis?.score ?? 0;
      const explanationScore    = rubric.explanation?.score ?? 0;
      const managementScore     = rubric.management?.score ?? 0;
      const prognosisScore      = rubric.prognosis_followup?.score ?? 0;
      const communicationScore  = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
