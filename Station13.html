<!-- OEBC OSCE Station 13 – Nystagmus & Visual Prognosis (Interactive, with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 13</h2>

  <p style="margin-top: 0; color: #555;">Oculomotor / Sensory Integrative &bull; Nystagmus &amp; Visual Prognosis (Interactive)</p>

  <!-- Step 1: Read -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

    <p><strong>Instructions:</strong> Read the scenario. Note: on the real OEBC OSCE you will have approximately 8 minutes for a station like this.</p>

    <p><strong>Scenario:</strong></p>

    <p>A 19-year-old college student is referred to you because of &ldquo;shaky eyes&rdquo; noticed since early childhood. She reports that she has always had some blur when looking at small print far away, but she can read and function in school. She is worried about whether her eyes are getting worse and asks if she will &ldquo;go blind&rdquo; or lose her driver&rsquo;s licence in the future.</p>

    <p>On exam, you observe a bilateral, horizontal, conjugate nystagmus that dampens in left gaze with a slight left face turn. Best-corrected acuities are 20/40 OD and 20/40 OS with low myopic astigmatic correction. Anterior and posterior segment exams are otherwise unremarkable. No neurologic red flags are present in history or examination, and previous records indicate a long-standing, non-progressive pattern consistent with early-onset (congenital) nystagmus.</p>

    <p><strong>Your task:</strong> Explain the diagnosis and visual prognosis to the patient using clear, patient-friendly language. Make sure you:</p>

    <ul>
      <li>State the diagnosis using words she can understand.</li>
      <li>Explain what nystagmus is and why her eyes move.</li>
      <li>Address her concerns about going blind and long-term vision stability.</li>
      <li>Discuss functional strategies (e.g., head turn, lighting, magnification, seating) and possible supports.</li>
      <li>Outline an appropriate follow-up and when to seek urgent care if anything changes.</li>
    </ul>
  </div>

  <!-- Step 2: Respond -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

    <p>Type what you would say to the patient:</p>
    <textarea id="s13-response" rows="8" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px;">
      <button type="button"
        onclick="document.getElementById('s13-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS13AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3 + 4: Key Points & Rubric (Hidden by Default) -->
  <div id="s13-key" style="display: none;">
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

      <ul>
        <li><strong>Diagnosis:</strong> Clearly state that she has a long-standing, early-onset (congenital) nystagmus.</li>
        <li><strong>Simple explanation:</strong> Describe that the eyes make small, involuntary movements, which can reduce clarity, especially for fine detail or at distance.</li>
        <li><strong>Prognosis:</strong> Reassure that this type of nystagmus is usually stable over time and does <em>not</em> lead to complete blindness, though vision may always be somewhat reduced.</li>
        <li><strong>Function &amp; supports:</strong> Mention strategies such as using her natural &ldquo;null point&rdquo; head turn, sitting closer in class, good lighting, large print, and possible low-vision aids if needed.</li>
        <li><strong>Driving / independence:</strong> Discuss that driving eligibility depends on legal acuity standards in her province; she may or may not meet them, but many people with similar vision function well with adaptations.</li>
        <li><strong>Monitoring:</strong> Explain the importance of routine follow-up to monitor vision and ocular health, and to revisit aids as her goals evolve.</li>
        <li><strong>Red flags:</strong> Advise that new symptoms such as sudden vision loss, new neurologic symptoms, or a change in the pattern of nystagmus would need urgent assessment.</li>
        <li><strong>Communication style:</strong> Use empathetic, validating language; acknowledge her worries and emphasize what can be done to support her functioning.</li>
      </ul>

      <p style="margin-top: 0.5rem; font-style: italic; color: #555;">
        For study purposes, make sure your answer includes at least: a clear diagnosis, a plain-language explanation of nystagmus, realistic but reassuring prognosis, at least two functional strategies, and a follow-up plan.
      </p>
    </div>

    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

      <p>Score each area 0&ndash;2 (0 = not addressed, 1 = partial, 2 = complete).</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Named nystagmus clearly and indicated that it is long-standing / early-onset.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained eye movements and their effect on clarity in simple, non-technical language.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Prognosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Addressed blindness fears, long-term stability, and realistic expectations.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management &amp; Supports</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Offered functional strategies (null point, seating, magnification/low-vision aids, lighting) and discussed follow-up.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Empathetic, organized, and tailored to her concerns (school, independence, driving).</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
        If you can consistently hit all domains on cases like this, you&rsquo;re practising at a level similar to OEBC interactive communication stations in the oculomotor / sensory integrative domain.
      </p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback (box is present but empty until button is clicked) -->
  <div id="s13-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s13-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      “Thanks for sharing your concerns with me. What you have is something we call
      <strong>early-onset, or congenital, nystagmus</strong>. That means your eyes make small, involuntary
      movements that have been present since you were very young. Because of those movements, the image on
      the back of the eye never stays perfectly still, which is why very small print or things far away can
      look a bit blurrier for you than for someone without nystagmus.<br><br>

      The important thing to know is that in your case this pattern has been stable for many years and your
      eye health looks good. This type of nystagmus does <strong>not</strong> typically lead to total blindness.
      Your vision may always be somewhat reduced compared with someone without nystagmus, but we can often help
      you function well with the right strategies and supports.<br><br>

      You’ve already found a helpful head position where the movement is a bit calmer – that’s called your
      “null point,” and it’s perfectly okay to use that. We can also talk about things like sitting a bit
      closer in class, using good lighting, larger print or electronic magnification, and, if needed, referral
      to a low-vision specialist for additional tools. We’ll plan to see you regularly to monitor your vision
      and eye health, and to adjust supports as your school and work demands change. If you ever notice a
      sudden change in your vision, new neurologic symptoms, or a big change in the way your eyes move, I’d
      want to see you sooner. How does that sound so far, and what questions do you have about your diagnosis
      or your long-term vision?”
    </div>
  </div>
</div>

<script>
  async function getS13AiFeedback() {
    const textArea     = document.getElementById("s13-response");
    const feedbackBox  = document.getElementById("s13-ai-box");
    const feedbackText = document.getElementById("s13-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 13,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;           // here: management & supports
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;   // prognosis / follow-up
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management &amp; Supports:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
