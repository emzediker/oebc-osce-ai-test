<!-- OEBC OSCE Station 3 – Hyperopia (Interactive, with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE – Station 3</h2>
  <p style="margin-top: 0; color: #555;">Module 1 – Refractive • Hyperopia (Interactive)</p>

  <!-- Step 1: Read -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">
    <h3 style="margin-top: 0;">Step 1 – Read the Station</h3>

    <p><strong>Note:</strong> On the real OEBC OSCE you will have about 8 minutes total for a station.</p>

    <p><strong>Scenario:</strong><br>
      A 38-year-old office worker reports eyestrain and frontal headaches after long days on the computer.
      Vision is “mostly fine” at distance, but they feel tired and blurry by the evening, especially at near.
      Refraction shows:
    </p>

    <ul style="margin-top: 0;">
      <li>OD: +1.50 DS → 20/20 distance, more comfortable at near</li>
      <li>OS: +1.25 DS → 20/20 distance, more comfortable at near</li>
    </ul>

    <p>Ocular health is normal. There is no history of systemic disease, medications, or prior ocular surgeries.</p>

    <p><strong>Your task:</strong><br>
      Explain the diagnosis and management plan to the patient in clear, patient-friendly language.
      Be sure to include:
    </p>
    <ul>
      <li>What hyperopia is and why their eyes feel tired.</li>
      <li>How focusing effort (accommodation) plays a role in symptoms and headaches.</li>
      <li>Appropriate correction options (e.g., near or full-time glasses, office lenses, contact lenses).</li>
      <li>What they should expect over time (presbyopia interaction / future changes).</li>
      <li>When they should return for follow-up.</li>
    </ul>
  </div>

  <!-- Step 2: Respond -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">
    <h3 style="margin-top: 0;">Step 2 – Speak (Type) Your Response</h3>

    <p>Type what you would say to the patient:</p>
    <textarea id="s3-response" rows="8" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px;">
      <button type="button"
        onclick="document.getElementById('s3-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS3AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3 + 4: Key Points & Rubric (Hidden by Default) -->
  <div id="s3-key" style="display: none;">
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">
      <h3 style="margin-top: 0;">Key Communication Points (What OEBC-style Stations Expect)</h3>
      <ul>
        <li><strong>Diagnosis:</strong> Clearly state the diagnosis as hyperopia (farsightedness).</li>
        <li><strong>Symptom Link:</strong> Explain that the eyes must work harder to focus up close, which can cause eyestrain and headaches.</li>
        <li><strong>Context:</strong> Connect the diagnosis to the patient’s specific symptoms (near/computer work, long days, evening fatigue).</li>
        <li><strong>Management Options:</strong> Describe reasonable correction strategies:
          <ul>
            <li>Near-only or office/computer glasses.</li>
            <li>Full-time wear if symptoms occur at distance as well.</li>
            <li>Contact lenses as an option if appropriate.</li>
          </ul>
        </li>
        <li><strong>Future Changes:</strong> Briefly mention how hyperopia and accommodation interact with future presbyopia (they may feel symptoms earlier than peers).</li>
        <li><strong>Follow-Up:</strong> Recommend a reasonable recall interval (e.g., yearly, or sooner if symptoms worsen).</li>
        <li><strong>Tone &amp; Clarity:</strong> Use clear, reassuring language and invite questions.</li>
      </ul>
    </div>

    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">
      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>
      <p>Score each area 0–2 (0 = not addressed, 1 = partial, 2 = complete).</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Clearly named hyperopia/farsightedness and linked it to symptoms.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained that extra focusing effort at near leads to strain/headaches in simple language.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Discussed appropriate lens options (near/office, full-time, CLs if appropriate) tailored to work demands.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Prognosis &amp; Follow-Up</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Mentioned future presbyopia/changes and recommended a recall interval.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Organized, empathetic explanation in patient-friendly language, with an invitation for questions.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
        Use this rubric to see how closely your response matches the style and content expected in an OEBC interactive station.
      </p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback (box is present but empty until button is clicked) -->
  <div id="s3-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s3-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      “You’re farsighted, which means your eyes are naturally focused a little behind where they need to be.
      For you, that’s especially noticeable up close and after long days on the computer. Your eyes have to
      constantly ‘pull focus’ to keep things clear, and that extra effort is what’s causing the eyestrain and
      frontal headaches you’ve been noticing.<br><br>

      The good news is that your eye health looks normal. Today’s prescription gives your eyes some help with
      that focusing effort, so the muscles don’t have to work quite as hard, especially at near. We can start
      with a pair of glasses designed for your computer and near tasks, and if you ever feel symptoms at distance
      as well, we can adjust the prescription or talk about full-time wear. If you’re interested, contact lenses
      can also be an option for your lifestyle.<br><br>

      Looking ahead, everyone eventually develops presbyopia, where the focusing system naturally becomes less
      flexible with age. Because you’re hyperopic, you may notice near symptoms a little earlier than some of your
      friends, but we can adjust your lenses over time to keep you comfortable. I’d like to see you about once a year,
      or sooner if your headaches return or you feel that the glasses aren’t helping anymore. Does this explanation
      make sense so far, and do you have any questions about the glasses or other options?”
    </div>
  </div>
</div>

<script>
  async function getS3AiFeedback() {
    const textArea     = document.getElementById("s3-response");
    const feedbackBox  = document.getElementById("s3-ai-box");
    const feedbackText = document.getElementById("s3-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 3,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      // Safely read scores
      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
