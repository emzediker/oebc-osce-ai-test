<!-- OEBC OSCE Station 36 – Wet AMD Urgent Referral (Interactive, with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 36</h2>

  <p style="margin-top: 0; color: #555;">Posterior Segment &bull; Wet AMD Urgent Referral (Interactive)</p>

  <!-- Step 1: Read the Station -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

    <p><strong>Instructions:</strong> Read the scenario carefully. On the real OEBC OSCE interactive stations, you would have 8 minutes.</p>

    <p><strong>Scenario:</strong>
      <br>A 72-year-old patient presents reporting a sudden dark spot in the center of vision in the right eye over the last week. Lines on the Amsler grid appear wavy. BCVA OD is 20/80 (previously 20/30). Fundus exam shows subretinal fluid and hemorrhage in the macula with elevation. OCT confirms intraretinal and subretinal fluid consistent with <strong>neovascular (wet) AMD</strong>.
    </p>

    <p><strong>Your task:</strong> Explain the diagnosis and the urgency of treatment to the patient in clear, patient-friendly language. Include: what wet AMD is, why vision changed suddenly, the need for urgent retinal referral, how anti-VEGF injections work, prognosis expectations, and the importance of monitoring the other eye.</p>
  </div>

  <!-- Step 2: Response -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 2 &ndash; Speak (or Type) Your Response</h3>

    <p>Type what you would say to the patient:</p>
    <textarea id="s36-response" rows="8"
      style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px;">
      <button type="button"
        onclick="document.getElementById('s36-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS36AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3 + 4: Key Points and Rubric -->
  <div id="s36-key" style="display: none;">
    <!-- Key Points -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3; background: #f5f7fb; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

      <ul>
        <li>State the diagnosis clearly: <strong>neovascular (wet) age-related macular degeneration</strong>.</li>
        <li>Explain that abnormal blood vessels are leaking fluid and blood under the retina.</li>
        <li>Connect this leakage to sudden central blur and distortion.</li>
        <li>Emphasize urgency: same-week or same-day retinal specialist referral.</li>
        <li>Explain anti-VEGF injections: how they reduce leakage, stabilize vision, and may improve vision.</li>
        <li>Clarify typical treatment frequency (often monthly early on, then tapered based on response).</li>
        <li>Discuss realistic prognosis: early treatment improves outcomes; untreated leads to permanent central vision loss.</li>
        <li>Advise monitoring the fellow eye with an Amsler grid and routine exams.</li>
        <li>Use supportive, clear, empathetic language to reduce anxiety.</li>
      </ul>
    </div>

    <!-- Rubric -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

      <p>Score each domain 0&ndash;2 (0 = not addressed, 1 = partial, 2 = complete).</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Clearly stated wet AMD and connected it to symptoms.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained abnormal vessels, leakage, and sudden vision changes in simple terms.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Discussed urgent referral plus anti-VEGF injections and their purpose.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Prognosis &amp; Follow-Up</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Gave realistic expectations, follow-up, and monitoring of the other eye.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Clear, organized, reassuring tone; accessible language.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">Meeting all domains consistently reflects OEBC-level interactive station competency.</p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback (box, hidden until clicked) -->
  <div id="s36-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s36-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      &ldquo;What we&rsquo;re seeing today is a form of macular degeneration called <strong>wet age-related macular degeneration</strong> in your right eye. That means that some abnormal, fragile blood vessels have grown under the center of your retina and are leaking fluid and a little bit of blood. That leakage is what caused the sudden dark spot and the wavy lines you&rsquo;re noticing on the Amsler grid.<br><br>

      This is <strong>more urgent</strong> than the dry form of macular degeneration. The sooner we start treatment, the better our chance of stabilizing or even improving your central vision. The main treatment is an <strong>anti-VEGF injection</strong>, which is a tiny injection of medication into the eye by a retinal specialist. The medicine tells those abnormal blood vessels to stop leaking and can help them shrink back. Most people need these injections fairly often at the beginning &mdash; usually every month for a while &mdash; and then the specialist may be able to space them out over time.<br><br>

      Our next step is to arrange a <strong>urgent referral to a retina specialist</strong>, ideally within the next few days. I&rsquo;ll send all of today&rsquo;s images and test results so they can move quickly. It&rsquo;s important to understand that this condition affects the central vision, which is what you use for reading and recognizing faces. Even with treatment, you may not get all of the lost vision back, but early and consistent treatment gives you the best chance of keeping as much central vision as possible.<br><br>

      We also need to keep a close eye on your <strong>other eye</strong>. I&rsquo;ll give you an Amsler grid to use at home to check each eye separately once or twice a week. If you ever notice new distortion, a new dark spot, or a sudden change in vision in either eye, that&rsquo;s a reason to call us or the retina specialist right away. Does that explanation make sense, and what questions do you have about the diagnosis or the injections?&rdquo;
    </div>
  </div>
</div>

<script>
  async function getS36AiFeedback() {
    const textArea     = document.getElementById("s36-response");
    const feedbackBox  = document.getElementById("s36-ai-box");
    const feedbackText = document.getElementById("s36-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 36,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
