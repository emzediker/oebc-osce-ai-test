<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OEBC Mock OSCE – Station 38 (PVD vs Retinal Tear)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f9;
      color: #222;
    }
    .oebc-station-step {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: #0b6bcb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .ai-panel {
      margin-top: 1.25rem;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #cfd8e3;
      background: #f5f7fb;
      font-size: 0.9rem;
    }
    .ai-score {
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .ai-error {
      color: #b00020;
      font-weight: 600;
    }
    .ai-loading {
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>
  <!-- OEBC OSCE Station 38 – PVD vs Retinal Tear Triage (AI-enabled) -->
  <div class="oebc-station-step">

    <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 38</h2>

    <p style="margin-top: 0; color: #555;">
      Posterior Segment &bull; PVD vs Retinal Tear Triage (Interactive)
    </p>

    <!-- Step 1: Read the Station -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

      <p><strong>Instructions:</strong> Read the scenario carefully. Note: on the real OEBC OSCE you will have approximately 8 minutes for a station like this.</p>

      <p><strong>Scenario:</strong></p>

      <p>
        A 58-year-old patient presents urgently, saying:
        <br>&ldquo;Yesterday evening I started seeing flashes of light in my right eye and a bunch of new floaters. It&rsquo;s freaking me out. I don&rsquo;t have any pain, but I&rsquo;m scared I might go blind.&rdquo;
        <br><br>
        Best-corrected visual acuity is 20/20 OD and 20/20 OS. Intraocular pressures are normal. Dilated fundus exam of the right eye shows a posterior vitreous detachment with a Weiss ring, no retinal tears or detachments seen on careful peripheral exam with scleral depression. The left eye is unremarkable.
      </p>

      <p><strong>Your task:</strong> Explain your findings and plan to the patient in clear, patient-friendly language. You must:</p>

      <ul>
        <li>State the likely diagnosis (posterior vitreous detachment).</li>
        <li>Reassure the patient about what you did <em>not</em> find today (no tear/detachment on exam).</li>
        <li>Explain the difference between a benign PVD and a retinal tear/detachment in simple terms.</li>
        <li>List the specific warning symptoms that require urgent re-evaluation.</li>
        <li>Describe your follow-up plan and why close monitoring is important.</li>
      </ul>
    </div>

    <!-- Step 2: Student Response -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

      <p>Type what you would say to the patient:</p>
      <textarea id="s38-response" rows="8"></textarea>

      <div style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:8px;">
        <button
          onclick="document.getElementById('s38-key').style.display='block'; this.disabled=true;"
          type="button">
          Show Key Points &amp; Rubric
        </button>

        <button type="button"
          onclick="getS38AiFeedback()"
          style="border: 1px solid #b91c1c;
                 background: #fff5f5; color: #7f1d1d;">
          Get AI-style Feedback (beta)
        </button>
      </div>
    </div>

    <!-- Step 3: Key Points + Rubric -->
    <div id="s38-key" style="display: none;">
      <!-- Key Points -->
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                  background: #f5f7fb; margin-bottom: 1rem;">

        <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

        <ul>
          <li><strong>Diagnosis stated:</strong> Clearly identifies a posterior vitreous detachment (PVD) in the right eye.</li>
          <li><strong>Findings &amp; reassurance:</strong> Explains that today&rsquo;s exam did <em>not</em> show a retinal tear or detachment.</li>
          <li><strong>Simple pathophysiology:</strong> Briefly describes that the &ldquo;gel&rdquo; in the eye is pulling away from the retina with age, creating flashes/floaters.</li>
          <li><strong>Risk explanation:</strong> Explains that a PVD can sometimes lead to a retinal tear or detachment, especially in the first weeks.</li>
          <li><strong>Red-flag symptoms:</strong> Clearly lists urgent symptoms such as:
            <ul>
              <li>sudden increase in floaters (a &ldquo;shower&rdquo; of spots),</li>
              <li>new or worsening flashes,</li>
              <li>a dark curtain/veil or shadow in peripheral or central vision,</li>
              <li>sudden drop in vision.</li>
            </ul>
          </li>
          <li><strong>Action plan for red flags:</strong> States that the patient must call immediately or go for emergency care if those symptoms occur.</li>
          <li><strong>Follow-up:</strong> Recommends an appropriate follow-up interval (e.g., recheck in 4&ndash;6 weeks, sooner if any changes).</li>
          <li><strong>Communication style:</strong> Uses calm, empathetic, non-alarming language while still conveying the seriousness of potential complications.</li>
        </ul>
      </div>

      <!-- Rubric -->
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

        <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

        <p>Score each area 0&ndash;2 (0 = not addressed, 1 = partial, 2 = clearly and complete). Total: 0&ndash;10.</p>

        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
          <thead>
            <tr>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis &amp; Findings</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Clearly named PVD and explained that no retinal tear or detachment was seen today.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Described in plain language how the vitreous separates and why this causes flashes/floaters.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Risk &amp; Red Flags</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained potential risk of retinal tear/detachment and clearly listed urgent warning symptoms.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Follow-Up Plan</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Gave a specific follow-up timeframe and clear instructions on what to do if symptoms change.</td>
            </tr>
            <tr>
              <td style="padding: 6px;"><strong>Communication</strong></td>
              <td style="padding: 6px;">Organized, empathetic, and clear; balanced reassurance with appropriate urgency.</td>
            </tr>
          </tbody>
        </table>

        <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
          If you consistently cover all domains on PVD / flashes &amp; floaters cases like this,
          you are practicing at the level expected for OEBC interactive posterior segment triage stations.
        </p>
      </div>
    </div>

    <!-- Step 4: AI-style Feedback (box appears after click) -->
    <div id="s38-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
      <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
      <div id="s38-ai-text" style="font-size:0.9rem;"></div>

      <!-- Example 10/10 response (static) -->
      <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
        <strong>Example 10/10 response:</strong><br>
        &ldquo;Based on what you’ve told me and what I see on your exam, you’re having something we call a
        <strong>posterior vitreous detachment</strong> in the right eye. Inside the eye there is a clear
        gel, like firm Jell-O, that is normally attached to the retina. As we get older that gel shrinks
        and loosens. When it pulls away from the retina it can cause <strong>flashes of light</strong>
        and new <strong>floaters</strong>, which is exactly what you noticed.<br><br>

        The good news is that today, with a very careful dilated exam, I did <strong>not</strong> see
        any tears or detachments of the retina. That means right now the retina itself is still attached,
        and there is no sign of bleeding or a “hole” in the retina on the exam.<br><br>

        A benign PVD like yours means the gel has pulled away without ripping the retina. A
        <strong>retinal tear or detachment</strong> is more serious &mdash; that’s when the gel tugs hard
        enough to actually tear the retina, and fluid can get underneath and peel it off like wallpaper.
        That can cause a dark curtain or shadow and permanent vision loss if it isn’t treated quickly.<br><br>

        For the next few weeks we need to watch you closely, because this is the time when a tear is most
        likely to develop if it’s going to. I want you to call us <strong>right away or go to emergency</strong>
        if you notice any of the following:
        more than just a couple of floaters &mdash; for example a sudden &ldquo;shower&rdquo; of black spots,
        new or worse flashes of light, a dark curtain or veil in your side vision, or any sudden drop in
        your vision.<br><br>

        Even if none of those warning signs show up, I still want to <strong>re-examine you in about
        4–6 weeks</strong> to make sure the retina still looks healthy. After that we’ll continue to
        check it at your regular visits. Most PVDs settle down over time and the flashes fade; the floaters
        may become less noticeable as your brain learns to ignore them.<br><br>

        I know this is scary to experience, but you did exactly the right thing by coming in quickly.
        We’ll keep a close eye on you, and if anything at all changes, I’d rather you call us and have it
        be nothing than wait on something important.&rdquo;
      </div>
    </div>
  </div>

  <script>
    async function getS38AiFeedback() {
      const textArea     = document.getElementById("s38-response");
      const feedbackBox  = document.getElementById("s38-ai-box");
      const feedbackText = document.getElementById("s38-ai-text");

      const userResponse = textArea.value.trim();
      if (!userResponse) {
        alert("Type something first so the AI has something to grade!");
        return;
      }

      // Reveal the box immediately
      feedbackBox.style.display = "block";
      feedbackText.textContent = "Working on your feedback…";

      try {
        const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
          },
          body: JSON.stringify({
            station_number: 38,
            user_response: userResponse
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
          return;
        }

        const data   = await res.json();
        const rubric = data.rubric || {};

        const diagnosisScore     = rubric.diagnosis?.score ?? 0;
        const explanationScore   = rubric.explanation?.score ?? 0;
        const managementScore    = rubric.management?.score ?? 0;
        const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
        const communicationScore = rubric.communication?.score ?? 0;

        let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
        if (typeof data.total_score === "number") {
          totalScore = data.total_score;
        }

        const overallComment = data.overall_comment || "";

        function badge(score) {
          let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
          if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
          if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

          return `<span style="
            display:inline-block;
            min-width:2.5rem;
            padding:2px 8px;
            border-radius:999px;
            font-size:0.75rem;
            font-weight:600;
            text-align:center;
            background:${bg};
            color:${color};
          ">${score}/2</span>`;
        }

        feedbackText.innerHTML = `
          <div>
            <p style="margin:0 0 6px;">
              ${badge(diagnosisScore)}
              &nbsp;<strong>Diagnosis &amp; Findings:</strong>
              ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(explanationScore)}
              &nbsp;<strong>Explanation:</strong>
              ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(managementScore)}
              &nbsp;<strong>Risk / Red Flags &amp; Plan:</strong>
              ${rubric.management?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(prognosisScore)}
              &nbsp;<strong>Follow-up &amp; Monitoring:</strong>
              ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 10px;">
              ${badge(communicationScore)}
              &nbsp;<strong>Communication:</strong>
              ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
            <p style="margin:0;">${overallComment}</p>
          </div>
        `;
      } catch (err) {
        feedbackText.textContent = "Network or setup error: " + err.message;
      }
    }
  </script>
</body>
</html>
