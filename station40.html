<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OEBC Mock OSCE – Station 40 (NAION Vascular Risk Counselling)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f9;
      color: #222;
    }
    .oebc-station-step {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: #0b6bcb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
  </style>
</head>
<body>
  <!-- OEBC OSCE Station 40 – NAION Vascular Risk Counselling (AI-enabled) -->
  <div class="oebc-station-step">

    <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 40</h2>

    <p style="margin-top: 0; color: #555;">
      Posterior Segment &bull; Optic Nerve / NAION (Interactive)
    </p>

    <!-- Step 1: Read the Station -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

      <p><strong>Context:</strong> On the real OEBC OSCE, you would have 8 minutes at this station to read the stem,
        think, and speak to the patient.</p>

      <p><strong>Scenario:</strong><br>
        A 62-year-old patient was referred to you after waking up with sudden, painless vision loss in the right eye
        3 days ago.<br>
        Best-corrected VA: 20/80 OD, 20/20 OS.<br>
        Fundus exam OD: swollen, pale optic disc with peripapillary hemorrhages; small, crowded disc in the fellow eye.<br>
        The patient has a history of hypertension and hyperlipidemia and reports &ldquo;snoring a lot&rdquo; according
        to their partner.
      </p>

      <p><strong>Your task:</strong><br>
        You have just completed your examination and you have diagnosed
        <strong>non-arteritic anterior ischemic optic neuropathy (NAION)</strong> in the right eye.
        Explain the diagnosis and management plan to the patient in clear, patient-friendly language.
        Your explanation should include:
      </p>

      <ul>
        <li>What NAION is and why the vision changed so suddenly.</li>
        <li>How systemic vascular risk factors (e.g., blood pressure, cholesterol, sleep apnea) are involved.</li>
        <li>Realistic prognosis for the affected eye and risk to the fellow eye.</li>
        <li>What further testing / referrals are needed (e.g., family doctor, possible sleep study,
          blood pressure and vascular risk review).</li>
        <li>Follow-up plan with you and what symptoms should prompt urgent review.</li>
      </ul>
    </div>

    <!-- Step 2: Student Response -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

      <p>Type what you would say to the patient:</p>
      <textarea id="s40-response" rows="8"></textarea>

      <div style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:8px;">
        <button
          type="button"
          onclick="document.getElementById('s40-key').style.display='block'; this.disabled=true;">
          Show Key Points &amp; Rubric
        </button>

        <button type="button"
          onclick="getS40AiFeedback()"
          style="border: 1px solid #b91c1c;
                 background: #fff5f5; color: #7f1d1d;">
          Get AI-style Feedback (beta)
        </button>
      </div>
    </div>

    <!-- Step 3: Key Points + Rubric -->
    <div id="s40-key" style="display: none;">
      <!-- Key Points -->
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                  background: #f5f7fb; margin-bottom: 1rem;">

        <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

        <ul>
          <li><strong>Clear diagnosis:</strong> Use the term &ldquo;non-arteritic ischemic optic neuropathy&rdquo; and
            immediately follow with a simple explanation (for example, &ldquo;a circulation problem to the optic nerve,
            like a small stroke of the eye&rdquo;).</li>
          <li><strong>Mechanism in plain language:</strong> Explain that blood flow to part of the optic nerve was
            reduced, causing sudden, painless vision loss.</li>
          <li><strong>Link to systemic risk factors:</strong> Connect NAION to high blood pressure, cholesterol,
            possible sleep apnea, and &ldquo;crowded&rdquo; optic nerve anatomy. Emphasize the need for good vascular
            health control.</li>
          <li><strong>Prognosis:</strong> Be honest but supportive &ndash; some small improvement may occur, but vision
            often does not fully return to normal; explain approximate risk to the fellow eye over time.</li>
          <li><strong>Management / referrals:</strong>
            <ul>
              <li>Advise follow-up with family doctor / internist for blood pressure, cholesterol, and vascular risk review.</li>
              <li>Mention possible evaluation for sleep apnea given snoring history.</li>
              <li>Clarify your ongoing role in monitoring the optic nerve and visual function.</li>
            </ul>
          </li>
          <li><strong>Safety-netting:</strong> Advise the patient to return urgently if there is new sudden change in
            vision in either eye, new visual field loss, or other concerning symptoms.</li>
          <li><strong>Communication style:</strong> Use calm, empathetic, non-blaming language; check understanding and
            invite questions.</li>
        </ul>
      </div>

      <!-- Rubric -->
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

        <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

        <p>Score yourself from 0&ndash;2 in each area (0 = not addressed, 1 = partially, 2 = well done).
          Total possible = 10.</p>

        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
          <thead>
            <tr>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">What to Look For</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Named NAION and gave a simple, accurate
                &ldquo;circulation problem to the optic nerve&rdquo; explanation.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Described sudden, painless vision loss and how
                reduced blood flow caused damage in a way a lay person can understand.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management &amp; Referrals</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Advised systemic workup (family doctor, vascular
                risk, possible sleep study) and described your follow-up plan.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Prognosis &amp; Risk</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Gave realistic expectations for vision in the
                affected eye and mentioned risk to the fellow eye without being alarmist.</td>
            </tr>
            <tr>
              <td style="padding: 6px;"><strong>Communication</strong></td>
              <td style="padding: 6px;">Used clear, empathetic language; organized explanation; encouraged questions and
                provided safety-net advice.</td>
            </tr>
          </tbody>
        </table>

        <p style="margin-top: 0.75rem; font-style: italic; color: #555;">
          If you consistently address all domains at this level, you&rsquo;re practicing at (or above) typical
          OEBC expectations for interactive posterior segment / optic nerve counselling stations.
        </p>
      </div>
    </div>

    <!-- Step 4: AI-style Feedback (box appears after click) -->
    <div id="s40-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
      <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
      <div id="s40-ai-text" style="font-size:0.9rem;"></div>

      <!-- Example 10/10 response (static) -->
      <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
        <strong>Example 10/10 response:</strong><br>
        &ldquo;Based on your symptoms and our examination today, you have a condition called
        <strong>non-arteritic anterior ischemic optic neuropathy</strong>, or NAION. In simple terms, this means that
        the blood flow to part of the optic nerve in your right eye was reduced, almost like a small stroke affecting
        the nerve. Because that blood supply dropped suddenly, you noticed a sudden, painless change in your vision.<br><br>

        Some of the things we know increase the risk of NAION are conditions that affect circulation, such as high
        blood pressure, high cholesterol, and possibly sleep apnea &mdash; which is when breathing repeatedly slows or
        stops during sleep. The shape of your optic nerve also plays a role; yours is quite &ldquo;crowded,&rdquo;
        which makes it more vulnerable when blood flow drops.<br><br>

        At this point, our main goals are to protect the vision you still have and reduce the chance of this happening
        again, especially in the other eye. Some people notice a small amount of improvement over the next few months,
        but the vision does not usually return completely to normal in the affected eye. There is also a small risk
        that the other eye could be affected in the future, which is why controlling your vascular risk factors is so
        important.<br><br>

        I&rsquo;m going to write to your family doctor to review your blood pressure, cholesterol, and other vascular
        risk factors, and to consider further testing such as a sleep study given the history of loud snoring. Treating
        things like sleep apnea, blood pressure, and cholesterol can help reduce the risk to the fellow eye and support
        your overall health.<br><br>

        I will continue to monitor your optic nerves and visual fields here. I would like to see you again in the next
        few weeks, and then periodically after that. If you notice any new, sudden change in the vision of either eye
        &mdash; for example a new dark area, missing patch of vision, or another sudden drop in clarity &mdash; please
        contact us or seek urgent care right away.<br><br>

        I know this is a lot to take in, and it can be upsetting to hear. You haven&rsquo;t done anything wrong, and
        we&rsquo;re going to work together with your medical team to look after both your eye health and your general
        health as best we can. Please feel free to ask any questions or tell me what worries you most right now.&rdquo;
      </div>
    </div>
  </div>

  <script>
    async function getS40AiFeedback() {
      const textArea     = document.getElementById("s40-response");
      const feedbackBox  = document.getElementById("s40-ai-box");
      const feedbackText = document.getElementById("s40-ai-text");

      const userResponse = textArea.value.trim();
      if (!userResponse) {
        alert("Type something first so the AI has something to grade!");
        return;
      }

      // Reveal the box immediately
      feedbackBox.style.display = "block";
      feedbackText.textContent = "Working on your feedback…";

      try {
        const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
          },
          body: JSON.stringify({
            station_number: 40,
            user_response: userResponse
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
          return;
        }

        const data   = await res.json();
        const rubric = data.rubric || {};

        const diagnosisScore     = rubric.diagnosis?.score ?? 0;
        const explanationScore   = rubric.explanation?.score ?? 0;
        const managementScore    = rubric.management?.score ?? 0;
        const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
        const communicationScore = rubric.communication?.score ?? 0;

        let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
        if (typeof data.total_score === "number") {
          totalScore = data.total_score;
        }

        const overallComment = data.overall_comment || "";

        function badge(score) {
          let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
          if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
          if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

          return `<span style="
            display:inline-block;
            min-width:2.5rem;
            padding:2px 8px;
            border-radius:999px;
            font-size:0.75rem;
            font-weight:600;
            text-align:center;
            background:${bg};
            color:${color};
          ">${score}/2</span>`;
        }

        feedbackText.innerHTML = `
          <div>
            <p style="margin:0 0 6px;">
              ${badge(diagnosisScore)}
              &nbsp;<strong>Diagnosis:</strong>
              ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(explanationScore)}
              &nbsp;<strong>Explanation:</strong>
              ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(managementScore)}
              &nbsp;<strong>Management &amp; Referrals:</strong>
              ${rubric.management?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(prognosisScore)}
              &nbsp;<strong>Prognosis &amp; Risk / Follow-up:</strong>
              ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 10px;">
              ${badge(communicationScore)}
              &nbsp;<strong>Communication:</strong>
              ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
            <p style="margin:0;">${overallComment}</p>
          </div>
        `;
      } catch (err) {
        feedbackText.textContent = "Network or setup error: " + err.message;
      }
    }
  </script>
</body>
</html>
