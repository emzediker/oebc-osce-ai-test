<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OEBC Mock OSCE – Station 57 (Ethics / Record-Keeping)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f9;
      color: #222;
    }
    .oebc-station-step {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: #0b6bcb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .ai-panel {
      margin-top: 1.25rem;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #cfd8e3;
      background: #f5f7fb;
      font-size: 0.9rem;
    }
    .ai-score {
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .ai-error {
      color: #b00020;
      font-weight: 600;
    }
    .ai-loading {
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>
  <!-- OEBC OSCE Station 57 – Ethics / Record-Keeping (AI-enabled) -->
  <div class="oebc-station-step">

    <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 57</h2>

    <p style="margin-top: 0; color: #555;">Other &bull; Ethics &amp; Record-Keeping (Interactive)</p>

    <!-- Step 1: Read the Station -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

      <p><strong>Instructions:</strong> Read the scenario carefully. On the real OEBC OSCE you will have limited time (about 8 minutes) to respond.</p>

      <p><strong>Scenario:</strong></p>

      <p>
        A 52-year-old patient comes in for a routine eye exam and vision test for a driver&rsquo;s licence renewal.
        After refraction, they see only 20/50 in the better eye with best correction, which does not meet
        the legal driving standard in your jurisdiction.
      </p>

      <p>
        When you explain this, the patient becomes frustrated and says:
        &ldquo;I&rsquo;ve been driving for 30 years with no accidents. If I lose my licence, I&rsquo;ll lose my job.
        Can you <em>please</em> just write that I met the standard? No one will ever know.&rdquo;
      </p>

      <p><strong>Your task:</strong> Speak to the patient in a professional, empathetic way and explain:</p>

      <ul style="margin-top: 0.4rem; padding-left: 1.2rem;">
        <li>Why you cannot falsify clinical records or licensing forms.</li>
        <li>Your legal and professional obligations for road safety and documentation.</li>
        <li>What options or next steps you <em>can</em> offer (e.g., treatment, referral, restrictions, re-testing).</li>
        <li>How you will document this conversation in the record.</li>
      </ul>
    </div>

    <!-- Step 2: Student Response -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

      <p>Type what you would say to the patient:</p>
      <textarea id="s57-response" rows="8"></textarea>

      <div style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:8px;">
        <button
          type="button"
          onclick="document.getElementById('s57-key').style.display='block'; this.disabled=true;">
          Show Key Points &amp; Rubric
        </button>

        <button type="button"
          id="s57-ai-btn"
          style="border: 1px solid #b91c1c;
                 background: #fff5f5; color: #7f1d1d;">
          Get AI Feedback &amp; Score
        </button>
      </div>
    </div>

    <!-- Step 3 + 4: Key Points & Rubric (Hidden by Default) -->
    <div id="s57-key" style="display: none;">
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                  background: #f5f7fb; margin-bottom: 1rem;">

        <h3 style="margin-top: 0;">Key Communication &amp; Ethics Points (What OEBC Expects)</h3>

        <ul>
          <li><strong>Empathy first:</strong> Acknowledge the patient&rsquo;s fear about job and independence.</li>
          <li><strong>State the boundary clearly:</strong> You cannot falsify clinical records or licence forms.</li>
          <li><strong>Link to obligations:</strong> Explain your legal/professional duty to public safety and College standards.</li>
          <li><strong>Clarify why accuracy matters:</strong> Records must reflect true findings; falsification is unethical and could harm others.</li>
          <li><strong>Offer options:</strong> Discuss treatment or referrals (e.g., cataract eval, low vision, possible restricted licence depending on jurisdiction, re-evaluation after management).</li>
          <li><strong>Summarize next steps:</strong> Explain what will go in the record and how you&rsquo;ll support them going forward.</li>
          <li><strong>Tone:</strong> Remain calm, non-judgmental, and respectful while holding firm boundaries.</li>
        </ul>
      </div>

      <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

        <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

        <p>Score each area 0&ndash;2 (0 = not addressed, 1 = partial, 2 = complete). Total possible = 10.</p>

        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
          <thead>
            <tr>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Empathy &amp; Rapport</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Acknowledged impact on patient&rsquo;s life and responded with understanding.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Ethical Boundary</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Clearly stated that falsifying records/forms is not acceptable.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Legal / Professional Duty</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Linked your decision to public safety, laws, and College/board standards.</td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management &amp; Options</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">Offered appropriate next steps (treatment, referral, re-eval, possible restrictions).</td>
            </tr>
            <tr>
              <td style="padding: 6px;"><strong>Professionalism &amp; Clarity</strong></td>
              <td style="padding: 6px;">Maintained calm, respectful tone; explanation was organized and easy to follow.</td>
            </tr>
          </tbody>
        </table>

        <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
          On OEBC interactive ethics/professionalism stations, assessors look for clear boundaries,
          patient-centred communication, and explicit recognition of your legal and professional responsibilities.
        </p>
      </div>
    </div>

    <!-- AI Feedback Panel -->
    <div id="s57-ai-panel" class="ai-panel">
      <div id="s57-ai-status" class="ai-loading" style="display:none;"></div>
      <div id="s57-ai-score" class="ai-score"></div>
      <div id="s57-ai-feedback"></div>
      <div id="s57-ai-error" class="ai-error"></div>

      <!-- Example 10/10 response (hidden until after AI feedback) -->
      <div id="s57-ai-example" style="display:none; margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
        <strong>Example 10/10 response:</strong><br>
        &ldquo;I can see this result is really stressful for you, especially if driving is important for your work
        and independence. I want you to know that I do understand how big a deal this feels.<br><br>

        At the same time, I have to be completely honest with you: I am not allowed to change the results or
        say that you meet the legal standard when you do not. As an optometrist, I&rsquo;m legally and
        professionally required to record exactly what I find and to be truthful on any driver&rsquo;s licence
        forms. If I were to write that your vision meets the requirement when it doesn&rsquo;t, that would be
        falsifying a medical document, and it could put you and others on the road at risk.&rdquo;<br><br>

        &ldquo;My responsibility is not only to you as my patient but also to public safety. If there was an
        accident and it turned out that I had signed a form that wasn&rsquo;t accurate, that could have serious
        consequences for both of us. So even though I sympathize with your situation, I can&rsquo;t change the
        numbers or say you passed when you didn&rsquo;t.&rdquo;<br><br>

        &ldquo;What I <strong>can</strong> do is focus on options to help you. We should look carefully for any
        treatable causes of the reduced vision &mdash; for example, cataracts or other eye conditions that might
        be improved with treatment, surgery, or different glasses. I can refer you to a specialist if we find
        something that could be improved. Depending on the laws here, there may also be the possibility of a
        restricted licence, but that decision is made by the licensing authority, not by me alone.&rdquo;<br><br>

        &ldquo;In your record today I&rsquo;m going to document the vision results, the fact that we discussed the
        driving standard, and your concerns about work. I&rsquo;ll also record any referrals or treatment plans we
        put in place so we have a clear trail of how we&rsquo;re trying to help. I know this isn&rsquo;t the news
        you were hoping for, but my goal is to support you honestly and safely. Let&rsquo;s go through the next
        steps together and make a plan.&rdquo;
      </div>
    </div>
  </div>

  <script>
    const s57Btn = document.getElementById("s57-ai-btn");
    const s57Status = document.getElementById("s57-ai-status");
    const s57Score = document.getElementById("s57-ai-score");
    const s57Feedback = document.getElementById("s57-ai-feedback");
    const s57Error = document.getElementById("s57-ai-error");
    const s57Example = document.getElementById("s57-ai-example");

    function badge(score, max) {
      const val = typeof score === "number" ? score : 0;
      const maxScore = max || 2;
      let bg = "#fee2e2", color = "#b91c1c"; // default red (0)
      if (val === 1) { bg = "#fef3c7"; color = "#92400e"; }   // yellow
      if (val >= 2) { bg = "#dcfce7"; color = "#166534"; }    // green

      return `
        <span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">
          ${val}/${maxScore}
        </span>
      `;
    }

    async function getS57AiFeedback() {
      const textArea = document.getElementById("s57-response");
      const userResponse = textArea.value.trim();

      if (!userResponse) {
        alert("Type your response first so the AI has something to review.");
        return;
      }

      s57Error.textContent = "";
      s57Score.textContent = "";
      s57Feedback.innerHTML = "";
      s57Status.style.display = "block";
      s57Status.textContent = "Asking AI to review your response…";
      s57Example.style.display = "none";
      s57Btn.disabled = true;

      try {
        const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
          },
          body: JSON.stringify({
            station_number: 57,
            user_response: userResponse
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          s57Status.style.display = "none";
          s57Error.textContent = "Supabase error " + res.status + ": " + txt;
          s57Btn.disabled = false;
          return;
        }

        const data = await res.json();
        const rubric = data.rubric || {};
        const overallComment = data.overall_comment || "";
        let totalScore = typeof data.total_score === "number" ? data.total_score : 0;
        let maxTotal = 0;

        let rubricHtml = "";

        Object.entries(rubric).forEach(([key, domain]) => {
          const label = domain.label || key;
          const score = domain.score ?? 0;
          const max = domain.max_score ?? 2;
          const comment = domain.comment || "No specific feedback from AI for this domain.";
          maxTotal += max;

          rubricHtml += `
            <p style="margin:0 0 6px;">
              ${badge(score, max)}
              &nbsp;<strong>${label}:</strong>
              ${comment}
            </p>
          `;
        });

        if (!totalScore && maxTotal) {
          // fallback: sum of domain scores if total_score wasn't provided
          totalScore = Object.values(rubric).reduce(
            (sum, d) => sum + (d.score ?? 0),
            0
          );
        }

        s57Status.style.display = "none";
        if (maxTotal) {
          s57Score.textContent = `AI Score: ${totalScore}/${maxTotal}`;
        }
        s57Feedback.innerHTML = rubricHtml + (overallComment
          ? `<p style="margin-top:8px;">${overallComment}</p>`
          : ""
        );

        // Now reveal the model answer after AI feedback is shown
        s57Example.style.display = "block";
      } catch (err) {
        s57Status.style.display = "none";
        s57Error.textContent = "Network or setup error: " + err.message;
      } finally {
        s57Btn.disabled = false;
      }
    }

    s57Btn.addEventListener("click", getS57AiFeedback);
  </script>
</body>
</html>
