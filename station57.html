<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OEBC Mock OSCE – Station 57 (Ethics & Record-Keeping)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f9;
      color: #222;
    }
    .oebc-station-step {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: #0b6bcb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
  </style>
</head>
<body>
  <!-- OEBC OSCE Station 57 – Ethics & Record-Keeping (AI-enabled) -->
  <div class="oebc-station-step">

    <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 57</h2>

    <p style="margin-top: 0; color: #555;">
      Other &bull; Ethics &amp; Record-Keeping (Interactive)
    </p>

    <!-- Step 1: Read the Station -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

      <p><strong>Instructions:</strong> Read the scenario carefully. On the real OEBC OSCE you will have limited time (about 8 minutes) to respond.</p>

      <p><strong>Scenario:</strong></p>

      <p>
        A 52-year-old patient comes in for a routine eye exam and vision test for a driver&rsquo;s licence renewal.
        After refraction, they see only 20/50 in the better eye with best correction, which does not meet the legal driving
        standard in your jurisdiction.
      </p>

      <p>
        When you explain this, the patient becomes frustrated and says:
        &ldquo;I&rsquo;ve been driving for 30 years with no accidents. If I lose my licence, I&rsquo;ll lose my job.
        Can you <em>please</em> just write that I met the standard? No one will ever know.&rdquo;
      </p>

      <p><strong>Your task:</strong><br />
        Speak to the patient in a professional, empathetic way and explain:
      </p>

      <ul style="margin-top: 0.4rem; padding-left: 1.2rem;">
        <li>Why you cannot falsify clinical records or licensing forms.</li>
        <li>Your legal and professional obligations for road safety and documentation.</li>
        <li>What options or next steps you <em>can</em> offer (e.g., treatment, referral, restrictions, re-testing).</li>
        <li>How you will document this conversation in the record.</li>
      </ul>
    </div>

    <!-- Step 2: Student Response -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

      <p>Type what you would say to the patient:</p>
      <textarea id="s57-response" rows="8"></textarea>

      <div style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:8px;">
        <button
          type="button"
          onclick="document.getElementById('s57-key').style.display='block'; this.disabled=true;">
          Show Key Points &amp; Rubric
        </button>

        <button type="button"
          onclick="getS57AiFeedback()"
          style="border: 1px solid #b91c1c;
                 background: #fff5f5; color: #7f1d1d;">
          Get AI-style Feedback (beta)
        </button>
      </div>
    </div>

    <!-- Step 3: Key Points + Rubric -->
    <div id="s57-key" style="display: none;">

      <!-- Key Points -->
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                  background: #f5f7fb; margin-bottom: 1rem;">

        <h3 style="margin-top: 0;">Key Communication &amp; Ethics Points (What OEBC Expects)</h3>

        <ul>
          <li><strong>Empathy first:</strong> Acknowledge the patient&rsquo;s fear about losing their licence, job, and independence.</li>
          <li><strong>State the boundary clearly:</strong> Explain that you cannot falsify clinical records or driver&rsquo;s licence forms under any circumstances.</li>
          <li><strong>Link to obligations:</strong> Describe your legal and professional duty to public safety and to follow College/board and licensing regulations.</li>
          <li><strong>Clarify why accuracy matters:</strong> Records and forms must reflect true findings; falsifying them is unethical, can endanger others, and could cost you your licence.</li>
          <li><strong>Offer options:</strong> Discuss what you <em>can</em> do &mdash; e.g., investigate causes of reduced vision (cataract, macular disease, refractive options), refer for treatment, explore possible restricted licence options if applicable in your jurisdiction, and arrange re-testing after management.</li>
          <li><strong>Summarize next steps:</strong> Outline your plan going forward and how you will document this conversation in the record.</li>
          <li><strong>Tone:</strong> Remain calm, respectful, and non-judgmental while holding firm boundaries.</li>
        </ul>
      </div>

      <!-- Rubric -->
      <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

        <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

        <p>Score each area 0&ndash;2 (0 = not addressed, 1 = partial, 2 = complete). Total possible = 10.</p>

        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
          <thead>
            <tr>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
              <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Empathy &amp; Rapport</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">
                Acknowledged the patient&rsquo;s concerns about work, independence, and frustration.
              </td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Ethical Boundary</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">
                Clearly stated that falsifying records or forms is not acceptable.
              </td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Legal / Professional Duty</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">
                Linked your decision to road safety, laws, and College/board standards.
              </td>
            </tr>
            <tr>
              <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management &amp; Options</strong></td>
              <td style="border-bottom: 1px solid #eee; padding: 6px;">
                Offered realistic next steps (investigation, treatment, referral, re-evaluation, possible restrictions if allowed).
              </td>
            </tr>
            <tr>
              <td style="padding: 6px;"><strong>Professionalism &amp; Clarity</strong></td>
              <td style="padding: 6px;">
                Maintained a calm, respectful tone and organized explanation that a layperson could follow.
              </td>
            </tr>
          </tbody>
        </table>

        <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
          On OEBC interactive ethics/professionalism stations, assessors look for clear boundaries, patient-centred communication,
          and explicit recognition of your legal and professional responsibilities.
        </p>
      </div>
    </div>

    <!-- Step 4: AI-style Feedback (box appears after click) -->
    <div id="s57-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
      <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
      <div id="s57-ai-text" style="font-size:0.9rem;"></div>

      <!-- Example 10/10 response (static, hidden until AI box is shown) -->
      <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
        <strong>Example 10/10 response:</strong><br>
        &ldquo;Thank you for being honest with me about how worried you are. I can hear that your driver&rsquo;s licence is
        closely tied to your job and your independence, and this is a really stressful situation. I&rsquo;m sorry that the
        test results today aren&rsquo;t what you were hoping for.<br><br>

        I do need to be very clear about one thing: I am <strong>not allowed to change the results or say that you met the
        standard when you did not</strong>. As an optometrist, I have a legal and professional responsibility to record your
        actual vision and to be truthful on any forms I sign. If I were to falsify your record or your driver&rsquo;s form,
        that would be unethical, it could put other people at risk on the road, and it could cost me my licence to practice.<br><br>

        The reason the standard exists is to protect you and others. If someone is driving with vision below the legal
        requirement, their reaction time and ability to see hazards, pedestrians, or signs can be reduced, especially at
        higher speeds or in poor conditions. My role is to advocate for your health and safety <em>and</em> for public
        safety, so I have to be honest about what we found today.<br><br>

        What I <strong>can</strong> do is work with you on next steps. Today we&rsquo;ve confirmed that your best-corrected
        vision in the better eye is 20/50. The next question is <em>why</em> it is reduced. We should look carefully at the
        health of the eye to see if there is anything treatable, such as cataracts or retinal changes. If there is a treatable
        cause, I can refer you to the appropriate specialist and, once treatment is done, we can recheck your vision and
        re-complete the licence form if you meet the standard at that time.<br><br>

        Depending on the rules in our province, there may also be options like a
        <strong>restricted or conditional licence</strong> that allows certain types of driving if you meet specific criteria.
        I can help by providing accurate information to the licensing authority, but I cannot guarantee what they will decide.
        My documentation today will reflect exactly what we measured and that we discussed the implications.<br><br>

        In your chart, I&rsquo;m going to record today&rsquo;s visual acuity, the results of the eye health examination, and
        the details of this conversation &mdash; including your concern about your job, my explanation of the legal standards,
        and the plan we&rsquo;ve agreed on for further investigation and possible treatment. That way, there is a clear record
        of what we discussed and how we are trying to help you move forward in a safe, ethical way.<br><br>

        I know this isn&rsquo;t the answer you were hoping for, but I want you to know that I&rsquo;m on your side. I&rsquo;ll
        do everything I can within the rules to support you &mdash; whether that&rsquo;s arranging further testing, referring
        you for treatment, or re-evaluating your vision if it improves. What questions do you have, or what worries you most
        right now that I can clarify?&rdquo;
      </div>
    </div>
  </div>

  <script>
    async function getS57AiFeedback() {
      const textArea     = document.getElementById("s57-response");
      const feedbackBox  = document.getElementById("s57-ai-box");
      const feedbackText = document.getElementById("s57-ai-text");

      const userResponse = textArea.value.trim();
      if (!userResponse) {
        alert("Type something first so the AI has something to grade!");
        return;
      }

      // Reveal the box immediately (this also reveals the 10/10 example, same as Station 55)
      feedbackBox.style.display = "block";
      feedbackText.textContent = "Working on your feedback…";

      try {
        const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
          },
          body: JSON.stringify({
            station_number: 57,
            user_response: userResponse
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
          return;
        }

        const data   = await res.json();
        const rubric = data.rubric || {};

        const diagnosisScore     = rubric.diagnosis?.score ?? 0;
        const explanationScore   = rubric.explanation?.score ?? 0;
        const managementScore    = rubric.management?.score ?? 0;
        const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
        const communicationScore = rubric.communication?.score ?? 0;

        let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
        if (typeof data.total_score === "number") {
          totalScore = data.total_score;
        }

        const overallComment = data.overall_comment || "";

        function badge(score) {
          let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
          if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
          if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

          return `<span style="
            display:inline-block;
            min-width:2.5rem;
            padding:2px 8px;
            border-radius:999px;
            font-size:0.75rem;
            font-weight:600;
            text-align:center;
            background:${bg};
            color:${color};
          ">${score}/2</span>`;
        }

        feedbackText.innerHTML = `
          <div>
            <p style="margin:0 0 6px;">
              ${badge(diagnosisScore)}
              &nbsp;<strong>Empathy &amp; Rapport / Diagnosis of the Issue:</strong>
              ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(explanationScore)}
              &nbsp;<strong>Explanation of Boundary &amp; Duty:</strong>
              ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(managementScore)}
              &nbsp;<strong>Management &amp; Options:</strong>
              ${rubric.management?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 6px;">
              ${badge(prognosisScore)}
              &nbsp;<strong>Prognosis / Next Steps &amp; Documentation:</strong>
              ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:0 0 10px;">
              ${badge(communicationScore)}
              &nbsp;<strong>Professionalism &amp; Clarity:</strong>
              ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
            </p>

            <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
            <p style="margin:0;">${overallComment}</p>
          </div>
        `;
      } catch (err) {
        feedbackText.textContent = "Network or setup error: " + err.message;
      }
    }
  </script>
</body>
</html>
