<!-- OEBC OSCE Station 5 – Presbyopia (Interactive, with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE – Station 5</h2>
  <p style="margin-top: 0; color: #555;">Module 1 – Refractive • Accommodative – Presbyopia (Interactive)</p>

  <!-- Step 1: Read -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">
    <h3 style="margin-top: 0;">Step 1 – Read the Station</h3>

    <p><strong>Note:</strong> On the real OEBC OSCE you will have 8 minutes.</p>

    <p><strong>Scenario:</strong><br>
      A 46-year-old reports increasing difficulty reading menus, phone screens, and small print at near.
      They remove their glasses to read and feel symptoms worsen in dim lighting. Ocular health is normal.
      Distance vision with their glasses is 20/20 OU.
    </p>

    <p><strong>Your task:</strong><br>
      Explain presbyopia in clear, patient-friendly language, including:
    </p>

    <ul>
      <li>the diagnosis</li>
      <li>why near vision is blurry</li>
      <li>how focusing ability changes over time</li>
      <li>appropriate correction options</li>
      <li>expected long-term changes</li>
      <li>recommended follow-up</li>
    </ul>
  </div>

  <!-- Step 2: Respond -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">
    <h3 style="margin-top: 0;">Step 2 – Speak (Type) Your Response</h3>

    <p>Type what you would say to the patient:</p>
    <textarea id="s5-response" rows="8"
      style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px;">
      <button type="button"
        onclick="document.getElementById('s5-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS5AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3 + 4: Key Points & Rubric (Hidden by Default) -->
  <div id="s5-key" style="display: none;">
    <!-- Key Points -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">
      <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

      <ul>
        <li>State the diagnosis: presbyopia (age-related focusing difficulty).</li>
        <li>Explain that the lens becomes less flexible, reducing near focusing ability.</li>
        <li>Connect symptoms: blurry near vision, worse in dim light, removing glasses to read.</li>
        <li>Discuss options: reading glasses, progressives, bifocals, multifocal contacts.</li>
        <li>Reassure that ocular health is normal.</li>
        <li>Explain that presbyopia progresses gradually into their mid-50s.</li>
        <li>Recommend routine annual exams to adjust the prescription over time.</li>
        <li>Use simple, empathetic, non-technical language.</li>
      </ul>
    </div>

    <!-- Rubric -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">
      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

      <p>Score 0–2 points in each area (0 = not addressed, 1 = partial, 2 = complete).</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Named presbyopia and linked to symptoms.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained age-related decline in lens flexibility.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Discussed reasonable correction options.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Prognosis &amp; Follow-Up</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Addressed progression &amp; annual recall.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Clear, supportive, patient-centered delivery.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
        Meeting all domains consistently reflects OEBC-level interactive communication performance.
      </p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback (box is present but empty until button is clicked) -->
  <div id="s5-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s5-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      “Thanks for coming in today. What you’re describing is very common in your mid-40s, and it has a
      name: <strong>presbyopia</strong>. That means the natural lens inside your eye isn’t as flexible as it
      used to be, so it’s harder for your eyes to adjust their focus up close. That’s why things like menus,
      your phone, and small print look blurry at near, and why it feels worse in dim lighting.<br><br>

      The good news is that your eyes themselves are healthy and your distance vision with your glasses is
      20/20. We just need to give you a bit of extra help for near tasks. There are a few ways we can do
      that: some people use simple reading glasses that they put on just for near work, others prefer
      progressive or bifocal lenses so they can see distance and near in the same pair of glasses, and some
      patients are good candidates for multifocal contact lenses. We can talk through which option best fits
      your day-to-day life and budget.<br><br>

      Presbyopia tends to progress gradually through your 40s and early 50s, so it’s normal if we need to
      gently increase the near power over the next several years. I recommend we see you about once a year,
      or sooner if you notice a big change, so we can keep your prescription up to date and make sure your
      eyes stay healthy. Does this explanation make sense so far, and do you have any questions or concerns
      about the different options?”
    </div>
  </div>
</div>

<script>
  async function getS5AiFeedback() {
    const textArea     = document.getElementById("s5-response");
    const feedbackBox  = document.getElementById("s5-ai-box");
    const feedbackText = document.getElementById("s5-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 5,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      // Safely read scores
      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
