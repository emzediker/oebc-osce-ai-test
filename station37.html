<!-- OEBC OSCE Station 37 – Retinitis Pigmentosa Prognosis & Low-Vision Referral (AI-enabled) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 37</h2>

  <p style="margin-top: 0; color: #555;">Posterior Segment &bull; Retinitis Pigmentosa (Interactive)</p>

  <!-- Step 1: Read the Station -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

    <p><strong>Scenario:</strong>
      <br>A 24-year-old reports difficulty seeing in dim lighting and trouble finding objects in peripheral vision. Family history: father and paternal aunt diagnosed with &ldquo;night blindness.&rdquo; Fundus exam shows bone-spicule pigmentation, attenuated vessels, and waxy pallor of the optic nerve. Goldmann visual field shows constricted peripheral fields.
    </p>

    <p><strong>Your task:</strong>
      <br>Explain the diagnosis, expected progression, driving implications, lifestyle modifications, and the importance of low-vision support services. Use clear, empathetic, patient-friendly language.
    </p>

    <p style="color:#666; font-style: italic;">Note: In the real OEBC OSCE, you would have 8 minutes to complete this station.</p>
  </div>

  <!-- Step 2: Student Response -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

    <p>Type what you would say to the patient:</p>
    <textarea id="s37-response" rows="8" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;
             font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display:flex; flex-wrap:wrap; gap:8px;">
      <button onclick="document.getElementById('s37-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;" type="button">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS37AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3: Key Points + Rubric -->
  <div id="s37-key" style="display: none;">
    <!-- Key Points -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

      <ul>
        <li>State diagnosis: <strong>Retinitis Pigmentosa (RP)</strong>.</li>
        <li>Explain the cause: inherited retinal degeneration affecting rods first, then cones.</li>
        <li>Relate symptoms to findings: night blindness &amp; peripheral field loss match the disease.</li>
        <li>Discuss realistic prognosis: gradual, long-term narrowing of visual field.</li>
        <li>Driving implications: may not meet legal peripheral vision requirements &mdash; depends on province.</li>
        <li>Recommend lifestyle strategies: good lighting, contrast enhancement, sunglasses for glare.</li>
        <li>Emphasize low-vision referral: orientation &amp; mobility, magnifiers, assistive technology.</li>
        <li>Optional: Mention genetic counseling &amp; emerging clinical trials (without promising cure).</li>
        <li>Use empathetic, supportive language acknowledging emotional impact.</li>
      </ul>
    </div>

    <!-- Rubric -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

      <p>Score yourself 0&ndash;2 in each category.</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Clearly stated RP and explained it simply.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Linked symptoms + fundus findings to disease mechanism.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Management</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Discussed LV referral, driving, lighting, safety.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Prognosis &amp; Follow-Up</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained gradual course and importance of monitoring.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Empathetic, organized, patient-centered.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
        Scoring high here indicates performance consistent with OEBC communication-based interactive stations.
      </p>
    </div>
  </div>

  <!-- Step 4: AI-style Feedback (box appears after click) -->
  <div id="s37-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s37-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      &ldquo;Based on your symptoms and our testing today, you have a condition called
      <strong>retinitis pigmentosa</strong>. That means some of the light-sensing cells in the
      back of the eye, especially the ones that help with night vision and side vision, are
      slowly wearing out over time. That fits with what you&rsquo;ve noticed &mdash; trouble
      seeing in dim light and bumping into things off to the side.<br><br>

      This is usually an inherited condition, which is why we sometimes see it run in families
      like yours. It tends to progress gradually over many years. Most people keep their central
      reading vision for quite a long time, but the visual field becomes more and more narrow,
      almost like looking through a tunnel.<br><br>

      One important topic we should talk about is <strong>driving</strong>. Because this condition
      affects side vision, some people with RP eventually don&rsquo;t meet the legal visual field
      requirements to drive safely. The exact rules depend on the province, so we&rsquo;ll check
      your visual field measurements against those standards and keep monitoring over time.
      Safety &mdash; yours and others&rsquo; &mdash; is our priority.<br><br>

      Although we don&rsquo;t yet have a cure to reverse the condition, there is a lot we can
      do to help you function as well as possible. Good lighting at home, using higher contrast
      (for example, bold print and good colour contrast), and sunglasses outdoors to reduce glare
      can all make daily tasks easier and more comfortable.<br><br>

      I&rsquo;m also going to refer you to a <strong>low-vision specialist</strong> and support
      services. They can help with tools like magnifiers, special reading devices, orientation
      and mobility training, and technology that can make school, work, and daily life much
      more manageable. We can also talk about genetic counselling and keep you updated about
      any new clinical trials that might be appropriate in the future, without promising any
      specific treatment today.<br><br>

      We&rsquo;ll see you regularly to monitor your vision and fields, and I want you to know
      you&rsquo;re not alone in this &mdash; our goal is to support you medically and
      practically so you can keep doing the things that matter to you.&rdquo;
    </div>
  </div>
</div>

<script>
  async function getS37AiFeedback() {
    const textArea     = document.getElementById("s37-response");
    const feedbackBox  = document.getElementById("s37-ai-box");
    const feedbackText = document.getElementById("s37-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 37,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
