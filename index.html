<script>
  async function getAiFeedback() {
    const textArea = document.getElementById("response");
    const feedbackBox = document.getElementById("ai-box");
    const feedbackText = document.getElementById("ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Show box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedbackâ€¦";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
  "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
}, 
        body: JSON.stringify({
          station_number: 1,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data = await res.json();
      const rubric = data.rubric || {};

      // Safely read scores for each domain
      const diagnosisScore   = rubric.diagnosis?.score ?? 0;
      const explanationScore = rubric.explanation?.score ?? 0;
      const managementScore  = rubric.management?.score ?? 0;
      const prognosisScore   = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      // Default: sum of domain scores
      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;

      // If the Edge Function also sent total_score, trust that
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      // Helper to make colored score badges
      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 = red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }   // 1/2 = yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }   // 2/2 = green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      const overallComment = data.overall_comment || "";

      feedbackText.innerHTML = `
        <div style="font-size:0.9rem;">
          <p style="margin:0 0 6px;"><strong>${badge(diagnosisScore)}</strong>
             &nbsp; <strong>Diagnosis:</strong>
             The candidate ${rubric.diagnosis?.comment || ""}</p>

          <p style="margin:0 0 6px;"><strong>${badge(explanationScore)}</strong>
             &nbsp; <strong>Explanation:</strong>
             ${rubric.explanation?.comment || ""}</p>

          <p style="margin:0 0 6px;"><strong>${badge(managementScore)}</strong>
             &nbsp; <strong>Management:</strong>
             ${rubric.management?.comment || ""}</p>

          <p style="margin:0 0 6px;"><strong>${badge(prognosisScore)}</strong>
             &nbsp; <strong>Prognosis &amp; follow-up:</strong>
             ${rubric.prognosis_followup?.comment || ""}</p>

          <p style="margin:0 0 10px;"><strong>${badge(communicationScore)}</strong>
             &nbsp; <strong>Communication:</strong>
             ${rubric.communication?.comment || ""}</p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
