<!-- OEBC OSCE Station 21 – Corneal Abrasion & Bandage CL Management (Interactive, with AI feedback) -->
<div class="oebc-station-step" style="max-width: 900px; margin: 0 auto; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">

  <h2 style="margin-bottom: 0.25rem;">OEBC Mock OSCE &ndash; Station 21</h2>

  <p style="margin-top: 0; color: #555;">Anterior Segment &bull; Corneal Abrasion &amp; Bandage CL Management (Interactive)</p>

  <!-- Step 1: Read the Station -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 1 &ndash; Read the Station</h3>

    <p><strong>Scenario:</strong>
      <br>A 27-year-old presents with sudden onset sharp pain, tearing, and light sensitivity in the right eye after accidentally scratching their eye while removing makeup. Slit-lamp exam shows a
      <strong>linear epithelial defect</strong> on the inferior cornea with no infiltrate. No foreign body. Anterior chamber is quiet.
    </p>

    <p><strong>Your task:</strong>
      <br>Explain the diagnosis and treatment plan in clear, patient-friendly language. Include <strong>what a corneal abrasion is</strong>, why antibiotic drops are needed, whether a <strong>bandage contact lens</strong> may help, expected healing time, warning signs, and follow-up timing.
    </p>

    <p style="color:#777; font-style:italic;">On the real OEBC OSCE, you would have 8 minutes to complete this interactive station.</p>
  </div>

  <!-- Step 2: Respond -->
  <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 1rem;">

    <h3 style="margin-top: 0;">Step 2 &ndash; Speak (Type) Your Response</h3>

    <p>Type what you would say to the patient:</p>
    <textarea id="s21-response" rows="8"
      style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem;"></textarea>

    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 8px;">
      <button type="button"
        onclick="document.getElementById('s21-key').style.display='block'; this.disabled=true;"
        style="padding: 9px 16px; border-radius: 999px; border: none;
               background: #0b6bcb; color: #fff; font-weight: 600; cursor: pointer;">
        Show Key Points &amp; Rubric
      </button>

      <button type="button"
        onclick="getS21AiFeedback()"
        style="padding: 9px 16px; border-radius: 999px; border: 1px solid #b91c1c;
               background: #fff5f5; color: #7f1d1d; font-weight: 600; cursor: pointer;">
        Get AI-style Feedback (beta)
      </button>
    </div>
  </div>

  <!-- Step 3: Key Points + Rubric (Hidden) -->
  <div id="s21-key" style="display: none;">
    <!-- Key Points -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #cfd8e3;
                background: #f5f7fb; margin-bottom: 1rem;">

      <h3 style="margin-top: 0;">Key Communication Points (What OEBC Expects)</h3>

      <ul>
        <li>State the diagnosis clearly: &ldquo;corneal abrasion&rdquo; or &ldquo;scratch on the surface of the eye.&rdquo;</li>
        <li>Explain symptoms: pain, tearing, light sensitivity are expected with abrasions.</li>
        <li>Reassure the patient: abrasions usually heal quickly (24&ndash;48 hours).</li>
        <li>Describe treatment: prophylactic <strong>antibiotic drops</strong> to prevent infection.</li>
        <li>Explain the role of a <strong>bandage contact lens</strong> (comfort, healing support) and when it is used.</li>
        <li>Set expectations: temporary blurry vision, mild discomfort tomorrow.</li>
        <li>Warning signs: worsening pain, decreased vision, discharge, increased redness &rarr; return urgently.</li>
        <li>Follow-up: usually 24 hours or next day.</li>
        <li>Use clear, empathetic, patient-friendly wording.</li>
      </ul>
    </div>

    <!-- Rubric -->
    <div style="padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fff;">

      <h3 style="margin-top: 0;">Self-Assessment Rubric</h3>

      <p>Score each area 0&ndash;2 (0 = not addressed, 1 = partial, 2 = complete).</p>

      <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Domain</th>
            <th style="border-bottom: 1px solid #ddd; padding: 6px; text-align: left;">Criteria</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Diagnosis</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Stated corneal abrasion + linked to mechanism of injury.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Explanation</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Explained symptoms + normal healing process in simple terms.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Treatment</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Discussed antibiotic drops; optional bandage CL role.</td>
          </tr>
          <tr>
            <td style="border-bottom: 1px solid #eee; padding: 6px;"><strong>Warning Signs</strong></td>
            <td style="border-bottom: 1px solid #eee; padding: 6px;">Mentioned return precautions clearly.</td>
          </tr>
          <tr>
            <td style="padding: 6px;"><strong>Communication</strong></td>
            <td style="padding: 6px;">Empathetic, clear, organized patient-friendly style.</td>
          </tr>
        </tbody>
      </table>

      <p style="margin-top: 0.75rem; color: #555; font-style: italic;">
        Consistently hitting all domains means you are communicating at OEBC interactive-station level.
      </p>
    </div>
  </div>

  <!-- Step 5: AI-style Feedback (box present but empty until clicked) -->
  <div id="s21-ai-box" style="display:none; margin-top: 1rem; padding: 14px; border-radius: 8px;
                             border: 1px dashed #f97316; background: #fff7ed;">
    <h3 style="margin-top: 0; font-size: 1rem;">AI-style Feedback (beta)</h3>
    <div id="s21-ai-text" style="font-size:0.9rem;"></div>

    <!-- Example 10/10 response (static) -->
    <div style="margin-top: 0.75rem; font-size: 0.85rem; color:#555;">
      <strong>Example 10/10 response:</strong><br>
      &ldquo;What you&rsquo;re feeling today is from a <strong>corneal abrasion</strong>, which basically means there is a small scratch on the clear window at the front of your eye. That layer has a lot of
      nerves, so even a small scratch can cause a lot of pain, tearing, and light sensitivity &mdash; that&rsquo;s all expected with this type of injury.<br><br>

      The good news is that these scratches almost always heal quickly, usually over the next 24&ndash;48 hours. To help protect the eye while it heals and to prevent infection, I&rsquo;m going to prescribe
      an <strong>antibiotic eye drop</strong> for you to use regularly today and tomorrow. Sometimes we also use a soft &ldquo;bandage&rdquo; contact lens to act like a cushion over the scratch &mdash;
      it doesn&rsquo;t correct your vision, but it can make things more comfortable while the surface heals.<br><br>

      Over the next day or two, it&rsquo;s normal for the eye to feel scratchy or mildly uncomfortable, and your vision in that eye may be a bit blurry. What I don&rsquo;t want to see is <strong>worsening</strong>
      pain, a big drop in vision, thick discharge, or the eye suddenly becoming much redder or more sensitive to light &mdash; those would be signs you should come back or be seen urgently.<br><br>

      I&rsquo;d like to see you again <strong>tomorrow/within 24 hours</strong> to make sure the scratch is healing well and that there are no signs of infection. In the meantime, try to rest the eye,
      avoid rubbing it, and don&rsquo;t wear any regular contact lenses until I say it&rsquo;s safe. Does this plan make sense, and what questions do you have about the abrasion or the drops?&rdquo;
    </div>
  </div>
</div>

<script>
  async function getS21AiFeedback() {
    const textArea     = document.getElementById("s21-response");
    const feedbackBox  = document.getElementById("s21-ai-box");
    const feedbackText = document.getElementById("s21-ai-text");

    const userResponse = textArea.value.trim();
    if (!userResponse) {
      alert("Type something first so the AI has something to grade!");
      return;
    }

    // Reveal the box immediately
    feedbackBox.style.display = "block";
    feedbackText.textContent = "Working on your feedback…";

    try {
      const res = await fetch("https://fpfduimmnaoyjxbmvgmz.supabase.co/functions/v1/ai-feedback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZmR1aW1tbmFveWp4Ym12Z216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjM5MzgsImV4cCI6MjA3OTM5OTkzOH0.-h0Cwwwfjr4s4voZ_KR2lhZgRmPaYLhaOfDCLhRc6gg"
        },
        body: JSON.stringify({
          station_number: 21,
          user_response: userResponse
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        feedbackText.textContent = "Supabase error " + res.status + ":\n" + txt;
        return;
      }

      const data   = await res.json();
      const rubric = data.rubric || {};

      const diagnosisScore     = rubric.diagnosis?.score ?? 0;
      const explanationScore   = rubric.explanation?.score ?? 0;
      const managementScore    = rubric.management?.score ?? 0;
      const prognosisScore     = rubric.prognosis_followup?.score ?? 0;
      const communicationScore = rubric.communication?.score ?? 0;

      let totalScore = diagnosisScore + explanationScore + managementScore + prognosisScore + communicationScore;
      if (typeof data.total_score === "number") {
        totalScore = data.total_score;
      }

      const overallComment = data.overall_comment || "";

      function badge(score) {
        let bg = "#fee2e2", color = "#b91c1c"; // 0/2 red
        if (score === 1) { bg = "#fef3c7"; color = "#92400e"; }  // 1/2 yellow
        if (score === 2) { bg = "#dcfce7"; color = "#166534"; }  // 2/2 green

        return `<span style="
          display:inline-block;
          min-width:2.5rem;
          padding:2px 8px;
          border-radius:999px;
          font-size:0.75rem;
          font-weight:600;
          text-align:center;
          background:${bg};
          color:${color};
        ">${score}/2</span>`;
      }

      feedbackText.innerHTML = `
        <div>
          <p style="margin:0 0 6px;">
            ${badge(diagnosisScore)}
            &nbsp;<strong>Diagnosis:</strong>
            ${rubric.diagnosis?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(explanationScore)}
            &nbsp;<strong>Explanation:</strong>
            ${rubric.explanation?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(managementScore)}
            &nbsp;<strong>Management:</strong>
            ${rubric.management?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 6px;">
            ${badge(prognosisScore)}
            &nbsp;<strong>Prognosis &amp; Follow-up:</strong>
            ${rubric.prognosis_followup?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:0 0 10px;">
            ${badge(communicationScore)}
            &nbsp;<strong>Communication:</strong>
            ${rubric.communication?.comment || "No specific feedback from AI for this domain."}
          </p>

          <p style="margin:8px 0 4px;"><strong>Total score: ${totalScore}/10</strong></p>
          <p style="margin:0;">${overallComment}</p>
        </div>
      `;
    } catch (err) {
      feedbackText.textContent = "Network or setup error: " + err.message;
    }
  }
</script>
